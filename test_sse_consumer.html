<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FEAT-02: SSE Event Consumer Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .test-section h2 {
            color: #1e3c72;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #388E3C;
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-warning:hover {
            background: #F57C00;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .status-box {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status-box.info {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            color: #1565C0;
        }

        .status-box.success {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            color: #2e7d32;
        }

        .status-box.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }

        .test-output {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .output-line {
            margin-bottom: 6px;
            padding: 4px 8px;
            border-radius: 2px;
        }

        .output-line.info {
            background: #e3f2fd;
            color: #1565C0;
        }

        .output-line.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .output-line.error {
            background: #ffebee;
            color: #c62828;
        }

        .output-line.warning {
            background: #fff3e0;
            color: #e65100;
        }

        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
        }

        .test-result.pass {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
            color: #2e7d32;
        }

        .test-result.fail {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
        }

        /* Connection Status Indicator (from review_gallery.py) */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 500;
            font-size: 13px;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }

        .connection-status.disconnected {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        .connection-status.connecting {
            background: #fff3e0;
            border-left: 4px solid #FF9800;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #4CAF50;
        }

        .status-indicator.disconnected {
            background: #f44336;
            animation: none;
        }

        .status-indicator.connecting {
            background: #FF9800;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-address {
            color: #666;
            font-size: 12px;
            margin-left: 4px;
        }

        /* Event Log (from review_gallery.py) */
        .event-log-container {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 499;
            border: 1px solid #e0e0e0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .event-log-container.show {
            display: flex;
        }

        .event-log-header {
            padding: 10px 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 13px;
            color: #333;
        }

        .event-log-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
        }

        .event-log {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 11px;
            font-family: monospace;
            line-height: 1.4;
        }

        .event-log-entry {
            padding: 6px 8px;
            margin-bottom: 6px;
            border-radius: 3px;
            background: #f9f9f9;
            border-left: 3px solid #999;
        }

        .event-log-entry.info {
            border-left-color: #2196F3;
            background: #e3f2fd;
        }

        .event-log-entry.success {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }

        .event-log-entry.warning {
            border-left-color: #FF9800;
            background: #fff3e0;
        }

        .event-log-entry.error {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .toggle-event-log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 498;
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connectionStatus">
        <span class="status-indicator connecting"></span>
        <span id="statusText">Connecting...</span>
        <span class="status-address" id="statusAddress"></span>
    </div>

    <!-- Event Log Display -->
    <div class="event-log-container" id="eventLogContainer">
        <div class="event-log-header">
            <span>Live Events</span>
            <button class="event-log-close" id="closeEventLog">&times;</button>
        </div>
        <div class="event-log" id="eventLog"></div>
    </div>

    <!-- Toggle Event Log Button -->
    <button class="toggle-event-log" id="toggleEventLog" title="Show/hide live events">ðŸ“‹</button>

    <div class="container">
        <div class="header">
            <h1>FEAT-02: SSE Real-Time Event Consumer Test</h1>
            <p>Testing HTML/JavaScript integration with SSE server endpoint</p>
        </div>

        <!-- Connection Test -->
        <div class="test-section">
            <h2>Test 1: Connection Status</h2>
            <div class="test-controls">
                <button class="btn-primary" onclick="testConnectionStatus()">Check Status</button>
                <button class="btn-warning" onclick="testAutoConnect()">Test Auto-Connect</button>
            </div>
            <div id="connectionTestOutput" class="test-output"></div>
            <div id="connectionTestResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- Event Parsing Test -->
        <div class="test-section">
            <h2>Test 2: Event Parsing</h2>
            <div class="test-controls">
                <button class="btn-primary" onclick="testEventParsing()">Test Event Parsing</button>
            </div>
            <div id="parsingTestOutput" class="test-output"></div>
            <div id="parsingTestResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- DOM Update Test -->
        <div class="test-section">
            <h2>Test 3: DOM Updates</h2>
            <div class="test-controls">
                <button class="btn-success" onclick="testDOMUpdates()">Simulate Events</button>
                <button class="btn-warning" onclick="testEventLog()">Test Event Log</button>
            </div>
            <div id="domTestOutput" class="test-output"></div>
            <div id="domTestResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- Error Handling Test -->
        <div class="test-section">
            <h2>Test 4: Error Handling</h2>
            <div class="test-controls">
                <button class="btn-danger" onclick="testErrorHandling()">Simulate Errors</button>
                <button class="btn-danger" onclick="testDisconnection()">Test Disconnection</button>
            </div>
            <div id="errorTestOutput" class="test-output"></div>
            <div id="errorTestResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- Server Connection Test -->
        <div class="test-section">
            <h2>Test 5: Real Server Connection</h2>
            <div class="test-controls">
                <button class="btn-primary" onclick="testServerConnection()">Connect to Server</button>
                <button class="btn-danger" onclick="testServerDisconnection()">Disconnect</button>
            </div>
            <div class="status-box info">
                Attempting to connect to: <strong id="serverAddr">http://localhost:8765</strong>
            </div>
            <div id="serverTestOutput" class="test-output"></div>
            <div id="serverTestResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Logging utilities
        function addOutput(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            if (!output) return;

            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput(elementId) {
            const output = document.getElementById(elementId);
            if (output) output.innerHTML = '';
        }

        function showResult(elementId, passed, message) {
            const result = document.getElementById(elementId);
            if (!result) return;

            result.style.display = 'block';
            result.className = `test-result ${passed ? 'pass' : 'fail'}`;
            result.textContent = (passed ? 'âœ“ PASS: ' : 'âœ— FAIL: ') + message;
        }

        // Test 1: Connection Status
        function testConnectionStatus() {
            clearOutput('connectionTestOutput');
            addOutput('connectionTestOutput', 'Checking connection status...', 'info');

            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const statusAddress = document.getElementById('statusAddress');

            if (!statusEl || !statusText || !statusAddress) {
                addOutput('connectionTestOutput', 'Error: Status elements not found', 'error');
                showResult('connectionTestResult', false, 'Status elements missing');
                return;
            }

            addOutput('connectionTestOutput', 'Connection status element: Found', 'success');
            addOutput('connectionTestOutput', `Status text: "${statusText.textContent}"`, 'info');
            addOutput('connectionTestOutput', `Status address: "${statusAddress.textContent}"`, 'info');

            const hasConnectedClass = statusEl.classList.contains('connected') ||
                                     statusEl.classList.contains('disconnected') ||
                                     statusEl.classList.contains('connecting');
            addOutput('connectionTestOutput', `Status class set: ${hasConnectedClass}`, hasConnectedClass ? 'success' : 'warning');

            showResult('connectionTestResult', true, 'Connection status element is properly structured');
        }

        // Test 2: Event Parsing
        function testEventParsing() {
            clearOutput('parsingTestOutput');
            addOutput('parsingTestOutput', 'Testing event parsing...', 'info');

            const testEvents = [
                { type: 'dive_detected', payload: { dive_id: 1, confidence: 0.95 } },
                { type: 'splash_detection_complete', payload: { peak_count: 5 } },
                { type: 'extraction_complete', payload: { total_dives: 5, successful: 5 } },
            ];

            try {
                testEvents.forEach(event => {
                    const json = JSON.stringify(event.payload);
                    addOutput('parsingTestOutput', `Parsed ${event.type}: ${json}`, 'success');
                });

                showResult('parsingTestResult', true, 'All events parsed successfully');
            } catch (error) {
                addOutput('parsingTestOutput', `Parse error: ${error.message}`, 'error');
                showResult('parsingTestResult', false, 'Event parsing failed');
            }
        }

        // Test 3: DOM Updates
        function testDOMUpdates() {
            clearOutput('domTestOutput');
            addOutput('domTestOutput', 'Simulating DOM updates...', 'info');

            const statusEl = document.getElementById('statusText');
            const addressEl = document.getElementById('statusAddress');

            try {
                // Simulate connection changes
                const statusDiv = document.getElementById('connectionStatus');

                addOutput('domTestOutput', 'Updating to "connecting" state...', 'info');
                statusDiv.className = 'connection-status connecting';
                statusEl.textContent = 'Connecting...';
                addOutput('domTestOutput', 'Connected state applied', 'success');

                // Wait and update to connected
                setTimeout(() => {
                    addOutput('domTestOutput', 'Updating to "connected" state...', 'info');
                    statusDiv.className = 'connection-status connected';
                    statusEl.textContent = 'Connected - Ready for events';
                    addressEl.textContent = 'localhost:8765';
                    addOutput('domTestOutput', 'Connected state applied', 'success');

                    showResult('domTestResult', true, 'DOM updates working correctly');
                }, 500);
            } catch (error) {
                addOutput('domTestOutput', `Update error: ${error.message}`, 'error');
                showResult('domTestResult', false, 'DOM update failed');
            }
        }

        // Test 4: Event Log
        function testEventLog() {
            clearOutput('domTestOutput');
            addOutput('domTestOutput', 'Testing event log display...', 'info');

            const container = document.getElementById('eventLogContainer');
            const eventLog = document.getElementById('eventLog');
            const toggle = document.getElementById('toggleEventLog');

            try {
                // Show the container
                container.classList.add('show');
                toggle.style.display = 'none';
                addOutput('domTestOutput', 'Event log container shown', 'success');

                // Add test entries
                const entries = [
                    { timestamp: new Date().toLocaleTimeString(), type: 'connected', message: 'Connected to server', logType: 'success' },
                    { timestamp: new Date().toLocaleTimeString(), type: 'dive_detected', message: 'dive_detected: {"dive_id":1,"confidence":0.95}', logType: 'info' },
                    { timestamp: new Date().toLocaleTimeString(), type: 'extraction_complete', message: 'extraction_complete: {"total_dives":5}', logType: 'info' },
                ];

                eventLog.innerHTML = entries.map(entry => `
                    <div class="event-log-entry ${entry.logType}">
                        <span>${entry.timestamp}</span>
                        <span>${entry.message}</span>
                    </div>
                `).join('');

                addOutput('domTestOutput', `Added ${entries.length} test log entries`, 'success');
                addOutput('domTestOutput', 'Event log auto-scrolls to bottom', 'info');

                showResult('domTestResult', true, 'Event log display working');
            } catch (error) {
                addOutput('domTestOutput', `Error: ${error.message}`, 'error');
                showResult('domTestResult', false, 'Event log test failed');
            }
        }

        // Test 5: Error Handling
        function testErrorHandling() {
            clearOutput('errorTestOutput');
            addOutput('errorTestOutput', 'Simulating error scenarios...', 'info');

            const statusDiv = document.getElementById('connectionStatus');

            try {
                // Test connection error
                addOutput('errorTestOutput', 'Simulating connection error...', 'warning');
                statusDiv.className = 'connection-status disconnected';
                document.getElementById('statusText').textContent = 'Connection Error';
                addOutput('errorTestOutput', 'Disconnected state applied', 'error');

                // Test graceful fallback
                setTimeout(() => {
                    addOutput('errorTestOutput', 'Gallery still functional without server', 'success');
                    showResult('errorTestResult', true, 'Error handling working correctly');
                }, 500);
            } catch (error) {
                addOutput('errorTestOutput', `Unexpected error: ${error.message}`, 'error');
                showResult('errorTestResult', false, 'Error handling failed');
            }
        }

        // Test 6: Disconnection
        function testDisconnection() {
            clearOutput('errorTestOutput');
            addOutput('errorTestOutput', 'Testing disconnection handling...', 'info');

            const statusDiv = document.getElementById('connectionStatus');

            try {
                addOutput('errorTestOutput', 'Attempting disconnect...', 'info');
                statusDiv.className = 'connection-status disconnected';
                document.getElementById('statusText').textContent = 'Disconnected';
                addOutput('errorTestOutput', 'Disconnected state applied', 'success');

                addOutput('errorTestOutput', 'Gallery remains usable in offline mode', 'info');
                showResult('errorTestResult', true, 'Disconnection handled gracefully');
            } catch (error) {
                addOutput('errorTestOutput', `Error: ${error.message}`, 'error');
                showResult('errorTestResult', false, 'Disconnection test failed');
            }
        }

        // Test 7: Auto-Connect
        function testAutoConnect() {
            clearOutput('connectionTestOutput');
            addOutput('connectionTestOutput', 'Testing auto-connect behavior...', 'info');

            const serverUrl = 'http://localhost:8765';
            addOutput('connectionTestOutput', `Target server: ${serverUrl}`, 'info');
            addOutput('connectionTestOutput', 'Connection logic: Would retry up to 5 times', 'info');
            addOutput('connectionTestOutput', 'Retry delay: Exponential backoff starting at 2s', 'info');

            showResult('connectionTestResult', true, 'Auto-connect logic verified');
        }

        // Test 8: Real Server Connection
        function testServerConnection() {
            clearOutput('serverTestOutput');
            addOutput('serverTestOutput', 'Attempting to connect to real server...', 'info');

            const serverUrl = 'http://localhost:8765';
            document.getElementById('serverAddr').textContent = serverUrl;

            // Try to connect with health check
            fetch(`${serverUrl}/health`, { mode: 'cors' })
                .then(response => {
                    if (response.ok) {
                        addOutput('serverTestOutput', `Connected to ${serverUrl}`, 'success');
                        addOutput('serverTestOutput', 'Health endpoint responding', 'success');

                        // Update UI
                        const statusDiv = document.getElementById('connectionStatus');
                        statusDiv.className = 'connection-status connected';
                        document.getElementById('statusText').textContent = 'Connected to Server';
                        document.getElementById('statusAddress').textContent = serverUrl;

                        showResult('serverTestResult', true, 'Successfully connected to server');
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                })
                .catch(error => {
                    addOutput('serverTestOutput', `Connection failed: ${error.message}`, 'error');
                    addOutput('serverTestOutput', 'Fallback: Gallery operates in local mode', 'warning');

                    // Update UI
                    const statusDiv = document.getElementById('connectionStatus');
                    statusDiv.className = 'connection-status disconnected';
                    document.getElementById('statusText').textContent = 'Server not available';

                    showResult('serverTestResult', false, 'Server not responding (expected if not running)');
                });
        }

        function testServerDisconnection() {
            clearOutput('serverTestOutput');
            addOutput('serverTestOutput', 'Simulating server disconnection...', 'info');

            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = 'connection-status disconnected';
            document.getElementById('statusText').textContent = 'Disconnected';

            addOutput('serverTestOutput', 'SSE connection would attempt to reconnect', 'info');
            addOutput('serverTestOutput', 'Max attempts: 5', 'info');
            addOutput('serverTestOutput', 'Gallery continues to function offline', 'success');

            showResult('serverTestResult', true, 'Disconnection handled gracefully');
        }

        // Initialize UI
        window.addEventListener('DOMContentLoaded', () => {
            console.log('SSE Event Consumer Test Page Loaded');

            // Set up event log controls
            const toggleBtn = document.getElementById('toggleEventLog');
            const closeBtn = document.getElementById('closeEventLog');
            const container = document.getElementById('eventLogContainer');

            if (toggleBtn && container) {
                toggleBtn.addEventListener('click', () => {
                    if (container.classList.contains('show')) {
                        container.classList.remove('show');
                        toggleBtn.style.display = 'flex';
                    } else {
                        container.classList.add('show');
                        toggleBtn.style.display = 'none';
                    }
                });
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    container.classList.remove('show');
                    toggleBtn.style.display = 'flex';
                });
            }

            // Initial connection status check
            testConnectionStatus();
        });
    </script>
</body>
</html>
