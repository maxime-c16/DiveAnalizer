<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiveAnalyzer - Live Review</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèä</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 28px; margin-bottom: 5px; color: #333; }
        .header p { color: #999; font-size: 14px; }
        .status-dashboard { background: white; border-radius: 8px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .phase-indicator { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .phase-icon { font-size: 48px; }
        .phase-info h2 { font-size: 20px; margin-bottom: 5px; color: #333; }
        .phase-info p { color: #999; font-size: 14px; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric { background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 4px solid #0066cc; }
        .metric-label { color: #999; font-size: 12px; text-transform: uppercase; margin-bottom: 10px; }
        .metric-value { font-size: 28px; font-weight: bold; color: #0066cc; }
        .progress-container { margin-top: 30px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 12px; color: #999; margin-bottom: 10px; }
        .progress-bar-wrapper { width: 100%; height: 8px; background: #e5e5e5; border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #0066cc, #00a8ff); transition: width 0.3s ease; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #e5e5e5; border-top-color: #0066cc; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .message-box { background: #f0f4f8; border-left: 4px solid #0066cc; padding: 15px; border-radius: 4px; color: #333; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèä DiveAnalyzer Live Review</h1>
            <p>Processing your video in real-time...</p>
        </div>

        <div class="status-dashboard">
            <div class="phase-indicator">
                <div class="phase-icon">üìä</div>
                <div class="phase-info">
                    <h2 id="phaseLabel">Audio Detection</h2>
                    <p id="phaseStatus">Analyzing audio for splash peaks...</p>
                </div>
                <div style="margin-left: auto;">
                    <div class="spinner"></div>
                </div>
            </div>

            <div class="metrics">
                <div class="metric">
                    <div class="metric-label">Dives Found</div>
                    <div class="metric-value" id="metricDives">0/0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Processing Speed</div>
                    <div class="metric-value" id="metricSpeed">0.0 dives/min</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Time Remaining</div>
                    <div class="metric-value" id="metricTime">--:--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Thumbnails Ready</div>
                    <div class="metric-value" id="metricThumbnails">0/0</div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-label">
                    <span id="progressLabel">Overall Progress</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="message-box" id="statusMessage" style="margin-top: 20px;">
                ‚è≥ Waiting for dives to be detected...
            </div>
        </div>
    </div>

    <script>
        const phaseNames = {
            'phase_1': 'üîä Audio Detection',
            'phase_2': 'üé¨ Motion Detection',
            'phase_3': 'üë§ Person Detection',
            'extraction': '‚úÇÔ∏è Clip Extraction',
            'thumbnails': 'üñºÔ∏è Thumbnail Generation'
        };

        const phaseStatuses = {
            'phase_1': 'Analyzing audio for splash peaks...',
            'phase_2': 'Detecting motion bursts in video...',
            'phase_3': 'Detecting person departures...',
            'extraction': 'Extracting dive clips...',
            'thumbnails': 'Generating thumbnails for each dive...'
        };

        function updateStatus(statusData) {
            try {
                const phase = statusData.phase || 'phase_1';
                const phaseName = phaseNames[phase] || statusData.phase_name || 'Processing';
                const phaseStatus = phaseStatuses[phase] || 'Processing...';

                console.log(`Status update: ${phaseName}, Dives: ${statusData.dives_found}/${statusData.dives_expected}, Progress: ${statusData.progress_percent}%`);

                // Update phase info
                const phaseLabel = document.getElementById('phaseLabel');
                const phaseStatusElem = document.getElementById('phaseStatus');
                if (phaseLabel) phaseLabel.textContent = phaseName;
                if (phaseStatusElem) phaseStatusElem.textContent = phaseStatus;

                // Update metrics with proper null checking
                const diveText = `${statusData.dives_found || 0}/${statusData.dives_expected || 0}`;
                const speedText = `${(statusData.processing_speed || 0).toFixed(2)} dives/min`;
                const thumbText = `${statusData.thumbnails_ready || 0}/${statusData.thumbnails_expected || 0}`;
                const timeText = calculateTimeRemaining(statusData);

                const metricDives = document.getElementById('metricDives');
                const metricSpeed = document.getElementById('metricSpeed');
                const metricTime = document.getElementById('metricTime');
                const metricThumbs = document.getElementById('metricThumbnails');

                if (metricDives) metricDives.textContent = diveText;
                if (metricSpeed) metricSpeed.textContent = speedText;
                if (metricTime) metricTime.textContent = timeText;
                if (metricThumbs) metricThumbs.textContent = thumbText;

                // Update progress bar
                const percent = Math.min(100, statusData.progress_percent || 0);
                const progressFill = document.getElementById('progressBarFill');
                const progressPercent = document.getElementById('progressPercent');
                if (progressFill) progressFill.style.width = percent + '%';
                if (progressPercent) progressPercent.textContent = Math.round(percent) + '%';

                // Update status message
                const statusMsg = document.getElementById('statusMessage');
                if (statusMsg) {
                    if (statusData.dives_found > 0) {
                        statusMsg.textContent = `‚úÖ Found ${statusData.dives_found} dive(s) - Processing...`;
                        statusMsg.style.borderLeftColor = '#28a745';
                        statusMsg.style.background = '#e8f5e9';
                    } else {
                        statusMsg.textContent = `‚è≥ Detecting dives...`;
                        statusMsg.style.borderLeftColor = '#0066cc';
                        statusMsg.style.background = '#f0f4f8';
                    }
                }
            } catch (err) {
                console.error('Error in updateStatus:', err);
            }
        }

        function calculateTimeRemaining(statusData) {
            if (statusData.processing_speed <= 0 || statusData.dives_expected <= 0) {
                return '--:--';
            }
            const remaining = Math.max(0, statusData.dives_expected - statusData.dives_found);
            if (remaining <= 0) return '0:00';
            const timeMinutes = remaining / statusData.processing_speed;
            const mins = Math.floor(timeMinutes);
            const secs = Math.round((timeMinutes - mins) * 60);
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        // Connect to SSE events
        const serverUrl = window.location.origin;
        try {
            const eventSource = new EventSource(serverUrl + '/events');

            eventSource.addEventListener('status_update', (e) => {
                try {
                    const data = JSON.parse(e.data);
                    updateStatus(data);
                } catch (err) {
                    console.error('Error parsing status_update:', err);
                }
            });

            eventSource.addEventListener('connected', (e) => {
                console.log('Connected to live event stream');
                document.getElementById('statusMessage').textContent = 'üîó Connected to server';
            });

            eventSource.addEventListener('gallery_ready', (e) => {
                try {
                    const data = JSON.parse(e.data);
                    console.log('Gallery ready - reloading page with real gallery...');
                    document.getElementById('statusMessage').textContent = '‚úÖ Gallery loaded! Switching to real gallery...';
                    // Reload immediately to show real gallery (removed 1s delay)
                    window.location.reload();
                } catch (err) {
                    console.error('Error handling gallery_ready:', err);
                }
            });

            eventSource.onerror = (e) => {
                // Suppress repetitive error logging but handle connection loss
                if (eventSource.readyState === EventSource.CLOSED) {
                    console.warn('SSE connection closed by server');
                    document.getElementById('statusMessage').textContent =
                        '‚úÖ Processing complete - preparing gallery...';
                } else if (eventSource.readyState === EventSource.CONNECTING) {
                    // Attempting to reconnect - suppress error
                    console.debug('Reconnecting to event stream...');
                }
                // Don't log error object (too verbose in console)
            };
        } catch (err) {
            console.warn('Could not connect to event stream:', err.message);
        }
    </script>
</body>
</html>